local npcCities = {
  ['Captain Bluebear'] = {'Carlin', 'Ab\'Dendriel', 'Venore', 'Port Hope', 'Liberty Bay', 'Svargrond', 'Yalahar', 'Roshamuul', 'Oramond', 'Edron'},
  ['Captain Greyhound'] = {'Thais', 'Ab\'Dendriel', 'Venore', 'Svargrond', 'Yalahar', 'Edron'},
  ['Captain Fearless'] = {'Issavi', 'Krailos', 'Thais', 'Carlin', 'Ab\'Dendriel', 'Port Hope', 'Edron', 'Darashia', 'Liberty Bay', 'Svargrond', 'Yalahar', 'Gray Island', 'Ankrahmun'},
  ['Captain Seagull'] = {'Thais', 'Carlin', 'Venore', 'Yalahar', 'Edron', 'Gray Island'},
  ['Captain Cookie'] = {'Liberty Bay'},
  ['Jack Fate'] = {'Edron', 'Thais', 'Venore', 'Darashia', 'Ankrahmun', 'Yalahar', 'Port Hope'},
  ['Charles'] = {'Thais', 'Darashia', 'Venore', 'Liberty Bay', 'Ankrahmun', 'Yalahar', 'Edron'},
  ['Karith'] = {'Ab\'Dendriel', 'Darashia', 'Venore', 'Ankrahmun', 'Port Hope', 'Thais', 'Liberty Bay', 'Carlin'},
  ['Captain Max'] = {'Calassa', 'Yalahar', 'Liberty Bay'},
  ['Captain Seahorse'] = {'Krailos', 'Thais', 'Carlin', 'Ab\'Dendriel', 'Venore', 'Port Hope', 'Ankrahmun', 'Liberty Bay', 'Gray Island', 'Cormaya'},
  ['Pemaret'] = {'Edron', 'Eremo'},
  ['Eremo'] = {'Cormaya'},
  ['Captain Pelagia'] = {'Edron', 'Darashia', 'Oramond', 'Venore'},
  ['Captain Gulliver'] = {'Thais', 'Krailos'},
  ['Captain Chelop'] = {'Thais'},
  ['Captain Harava'] = {'Oramond', 'Krailos', 'Venore', 'Darashia'}
}

local npcs = {
  'Captain Bluebear',
  'Captain Greyhound',
  'Captain Fearless',
  'Captain Seagull',
  'Captain Cookie',
  'Jack Fate',
  'Charles',
  'Karith',
  'Captain Max',
  'Captain Seahorse',
  'Pemaret',
  'Eremo',
  'Captain Pelagia',
  'Captain Gulliver',
  'Captain Chelop',
  'Captain Harava'
}


-- Interfaz de usuario
g_ui.loadUIFromString([[
CityTravelWindow < MainWindow
  text: Viajar a
  size: 110 70

  ComboBox
    id: travelOptions
    anchors.horizontalCenter: parent.horizontalCenter
    anchors.top: parent.top
    margin-top: 1
    width: 80
    height: 20

  HorizontalSeparator
    id: separator
    anchors.horizontalCenter: parent.horizontalCenter
    anchors.top: travelOptions.bottom
    margin-top: 5

]])

local panelName = "cityTravel"
if not storage[panelName] then
  storage[panelName] = {
    enabled = false,
  }
end

local config = storage[panelName]

rootWidget = g_ui.getRootWidget()
if rootWidget then
  local cityTravelWindow = UI.createWindow('CityTravelWindow', rootWidget)
  cityTravelWindow:hide()

  for _, npcName in ipairs(npcs) do
    NPC[npcName] = function(text)
        if g_game.getClientVersion() >= 810 then
            g_game.talkChannel(11, 0, text)
        else
            return say(text)
        end
    end
  end

  local function updateTravelOptions(npcName)
    cityTravelWindow:recursiveGetChildById('travelOptions'):clearOptions()
    cityTravelWindow:recursiveGetChildById('travelOptions'):addOption("Ninguna")
    if npcCities[npcName] then
      for _, city in ipairs(npcCities[npcName]) do
        cityTravelWindow:recursiveGetChildById('travelOptions'):addOption(city)
      end
    end
  end

  macro(100, function()
    for _, npcName in ipairs(npcs) do
      local findNpc = getCreatureByName(npcName)
      local playerPos = pos()
      if findNpc and getDistanceBetween(playerPos, findNpc:getPosition()) <= 2 then
        updateTravelOptions(npcName)
        cityTravelWindow:show()
        break
      else
        cityTravelWindow:hide()
      end
    end
  end)

  cityTravelWindow:recursiveGetChildById('travelOptions').onOptionChange = function(widget, option, data)
    if option ~= "Ninguna" then
      say('hi')
      schedule(2000, function()  -- 2 seconds delay
        for _, npcName in ipairs(npcs) do
          local findNpc = getCreatureByName(npcName)
          if findNpc and getDistanceBetween(pos(), findNpc:getPosition()) <= 2 then
            NPC[npcName](option)
          end
        end
      end)
      schedule(4000, function()  -- 4 seconds delay from the start (2 seconds after the previous command)
        for _, npcName in ipairs(npcs) do
          local findNpc = getCreatureByName(npcName)
          if findNpc and getDistanceBetween(pos(), findNpc:getPosition()) <= 2 then
            NPC[npcName]('yes')
          end
        end
      end)
    end
  end
end





